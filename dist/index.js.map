{"version":3,"sources":["../src/index.ts"],"sourcesContent":["import { Redis } from \"ioredis\";\nimport { AdapterFunction, SessionAdapter, SessionSchema } from \"lucia-auth\";\n\ntype Params = {\n  session: Redis;\n  namespaces?: {\n    session: string;\n    userSession: string;\n  };\n};\n\nconst DEFAULT_NAMESPACES = {\n  session: \"session\",\n  userSession: \"userSession\",\n};\n\nconst adapter = ({\n  session: sessionRedis,\n  namespaces = DEFAULT_NAMESPACES,\n}: Params): AdapterFunction<SessionAdapter> => {\n  const calcSessionKey = (sessionId: string) =>\n    `${namespaces.session}:${sessionId}`;\n  const calcUserSessionKey = (userId: string) =>\n    `${namespaces.userSession}:${userId}`;\n\n  return () => ({\n    getSession: async (sessionId: string) => {\n      const sessionData = await sessionRedis.get(calcSessionKey(sessionId));\n      return sessionData ? (JSON.parse(sessionData) as SessionSchema) : null;\n    },\n    getSessionsByUserId: async (userId: string) => {\n      const sessionIds = await sessionRedis.lrange(userId, 0, -1);\n      const sessions = await Promise.all(\n        sessionIds.map(async (sessionId) => {\n          const sessionData = await sessionRedis.get(calcSessionKey(sessionId));\n          return sessionData ? JSON.parse(sessionData) : null;\n        })\n      );\n      return sessions.filter(\n        (session): session is SessionSchema => session !== null\n      );\n    },\n    setSession: async (session) => {\n      await Promise.all([\n        sessionRedis.set(calcUserSessionKey(session.user_id), session.id),\n        sessionRedis.set(\n          calcSessionKey(session.id),\n          JSON.stringify(session),\n          \"EX\",\n          Math.floor(Number(session.idle_expires) / 1000)\n        ),\n      ]);\n    },\n    deleteSession: async (...sessionIds: string[]) => {\n      const targetSessionIds = await Promise.all(\n        sessionIds.map(async (sessionId) => {\n          return sessionRedis.get(calcSessionKey(sessionId));\n        })\n      );\n      const sessions = targetSessionIds\n        .filter((sessionId): sessionId is string => sessionId !== null)\n        .map((sessionId) => JSON.parse(sessionId) as SessionSchema);\n      await Promise.all([\n        ...sessionIds.map((sessionId) => {\n          return sessionRedis.del(calcSessionKey(sessionId));\n        }),\n        ...sessions.map((session) => {\n          return sessionRedis.lrem(\n            calcUserSessionKey(session.user_id),\n            0,\n            session.id\n          );\n        }),\n      ]);\n    },\n    deleteSessionsByUserId: async (userId: string) => {\n      const sessionIds = await sessionRedis.lrange(userId, 0, -1);\n      await Promise.all([\n        ...sessionIds.map((sessionId) => {\n          return sessionRedis.del(calcSessionKey(sessionId));\n        }),\n        sessionRedis.del(calcUserSessionKey(userId)),\n      ]);\n    },\n  });\n};\nexport default adapter;\n"],"mappings":";AAWA,IAAM,qBAAqB;AAAA,EACzB,SAAS;AAAA,EACT,aAAa;AACf;AAEA,IAAM,UAAU,CAAC;AAAA,EACf,SAAS;AAAA,EACT,aAAa;AACf,MAA+C;AAC7C,QAAM,iBAAiB,CAAC,cACtB,GAAG,WAAW,WAAW;AAC3B,QAAM,qBAAqB,CAAC,WAC1B,GAAG,WAAW,eAAe;AAE/B,SAAO,OAAO;AAAA,IACZ,YAAY,OAAO,cAAsB;AACvC,YAAM,cAAc,MAAM,aAAa,IAAI,eAAe,SAAS,CAAC;AACpE,aAAO,cAAe,KAAK,MAAM,WAAW,IAAsB;AAAA,IACpE;AAAA,IACA,qBAAqB,OAAO,WAAmB;AAC7C,YAAM,aAAa,MAAM,aAAa,OAAO,QAAQ,GAAG,EAAE;AAC1D,YAAM,WAAW,MAAM,QAAQ;AAAA,QAC7B,WAAW,IAAI,OAAO,cAAc;AAClC,gBAAM,cAAc,MAAM,aAAa,IAAI,eAAe,SAAS,CAAC;AACpE,iBAAO,cAAc,KAAK,MAAM,WAAW,IAAI;AAAA,QACjD,CAAC;AAAA,MACH;AACA,aAAO,SAAS;AAAA,QACd,CAAC,YAAsC,YAAY;AAAA,MACrD;AAAA,IACF;AAAA,IACA,YAAY,OAAO,YAAY;AAC7B,YAAM,QAAQ,IAAI;AAAA,QAChB,aAAa,IAAI,mBAAmB,QAAQ,OAAO,GAAG,QAAQ,EAAE;AAAA,QAChE,aAAa;AAAA,UACX,eAAe,QAAQ,EAAE;AAAA,UACzB,KAAK,UAAU,OAAO;AAAA,UACtB;AAAA,UACA,KAAK,MAAM,OAAO,QAAQ,YAAY,IAAI,GAAI;AAAA,QAChD;AAAA,MACF,CAAC;AAAA,IACH;AAAA,IACA,eAAe,UAAU,eAAyB;AAChD,YAAM,mBAAmB,MAAM,QAAQ;AAAA,QACrC,WAAW,IAAI,OAAO,cAAc;AAClC,iBAAO,aAAa,IAAI,eAAe,SAAS,CAAC;AAAA,QACnD,CAAC;AAAA,MACH;AACA,YAAM,WAAW,iBACd,OAAO,CAAC,cAAmC,cAAc,IAAI,EAC7D,IAAI,CAAC,cAAc,KAAK,MAAM,SAAS,CAAkB;AAC5D,YAAM,QAAQ,IAAI;AAAA,QAChB,GAAG,WAAW,IAAI,CAAC,cAAc;AAC/B,iBAAO,aAAa,IAAI,eAAe,SAAS,CAAC;AAAA,QACnD,CAAC;AAAA,QACD,GAAG,SAAS,IAAI,CAAC,YAAY;AAC3B,iBAAO,aAAa;AAAA,YAClB,mBAAmB,QAAQ,OAAO;AAAA,YAClC;AAAA,YACA,QAAQ;AAAA,UACV;AAAA,QACF,CAAC;AAAA,MACH,CAAC;AAAA,IACH;AAAA,IACA,wBAAwB,OAAO,WAAmB;AAChD,YAAM,aAAa,MAAM,aAAa,OAAO,QAAQ,GAAG,EAAE;AAC1D,YAAM,QAAQ,IAAI;AAAA,QAChB,GAAG,WAAW,IAAI,CAAC,cAAc;AAC/B,iBAAO,aAAa,IAAI,eAAe,SAAS,CAAC;AAAA,QACnD,CAAC;AAAA,QACD,aAAa,IAAI,mBAAmB,MAAM,CAAC;AAAA,MAC7C,CAAC;AAAA,IACH;AAAA,EACF;AACF;AACA,IAAO,cAAQ;","names":[]}